<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SPX 0DTE Iron Condor Dashboard</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="p-4 bg-light">
    <div class="container">
      <h1>SPX 0DTE Iron Condor Analyzer</h1>
      <div id="status" class="mb-3 text-muted">Loading...</div>
      <button class="btn btn-primary mb-3" onclick="analyze()">
        Analyze Market
      </button>

      <h3>Top Opportunities</h3>
      <table class="table table-bordered table-sm" id="opportunities">
        <thead>
          <tr>
            <th>Score</th>
            <th>Strikes</th>
            <th>Premium</th>
            <th>Reward:Risk</th>
            <th>Delta Î”</th>
            <th>IV Avg</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <h3>Current Positions</h3>
      <ul id="positions" class="list-group"></ul>
    </div>

    <script>
      async function loadDashboard() {
        const statusRes = await fetch("/api/status");
        const status = await statusRes.json();
        document.getElementById(
          "status"
        ).textContent = `SPX: ${status.spx_price} | Last: ${status.last_analysis}`;

        const dataRes = await fetch("/api/analysis");
        const data = await dataRes.json();
        const rows = data.scored_trades
          .map(
            (t) => `
                <tr>
                    <td>${t.score}</td>
                    <td>${t.short_put} / ${t.long_put} | ${t.short_call} / ${
              t.long_call
            }</td>
                    <td>${t.premium}</td>
                    <td>${t.reward_to_risk}</td>
                    <td>${Math.abs(
                      t.short_call_delta - t.short_put_delta
                    ).toFixed(2)}</td>
                    <td>${((t.call_iv + t.put_iv) / 2).toFixed(1)}%</td>
                </tr>
            `
          )
          .join("");
        document.querySelector("#opportunities tbody").innerHTML = rows;

        const posList = data.current_positions
          .map(
            (p) => `
                <li class="list-group-item d-flex justify-content-between">
                    ${p.short_put} / ${p.short_call} (${p.timestamp})
                    ${
                      p.closed
                        ? '<span class="badge bg-secondary">Closed</span>'
                        : `<button class="btn btn-sm btn-danger" onclick="closePosition('${p.id}')">Close</button>`
                    }
                </li>
            `
          )
          .join("");
        document.getElementById("positions").innerHTML = posList;
      }

      async function analyze() {
        await fetch("/api/analyze", { method: "POST" });
        loadDashboard();
      }

      async function closePosition(id) {
        await fetch(`/api/position/${id}/close`, { method: "POST" });
        loadDashboard();
      }

      loadDashboard();
      setInterval(loadDashboard, 10000); // Auto-refresh every 10s
    </script>
  </body>
</html>
